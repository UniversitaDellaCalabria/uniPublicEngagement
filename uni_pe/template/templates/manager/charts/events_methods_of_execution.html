{% load i18n %}
{% load pe_management_tags %}

{% pem_settings_value "DASHBOARD_KPI_LIST" as titles %}
<div class="col-12">
  <div class="card-wrapper card-space">
    <div class="card card-bg no-after">
      <div class="card-body">
        <p class="card-title h5">
          {% for title in titles %}
          {% if title.0 == request.GET.kpi %}
          {{ title.1 }}
          {% endif %}
          {% endfor %}
        </p>
        <div id="app_events_methods_of_execution">
          <div v-if="error">
            <div class="alert alert-danger" role="alert">
              {% trans "Data retrieval failed. Please check your search parameters" %}
            </div>
          </div>
          <div id="chart_events_methods_of_execution" v-else></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var options_events_methods_of_execution = {
    series: [{
      data: []
    }],
    chart: {
      type: 'bar',
      height: 300
    },
    plotOptions: {
      bar: {
        barHeight: '100%',
        distributed: true,
        horizontal: true,
        dataLabels: {
          position: 'bottom'
        },
      }
    },
    colors: ['#33b2df', '#546E7A', '#d4526e', '#13d8aa', '#A5978B', '#2b908f', '#f9a3a4', '#90ee7e',
    '#f48024', '#69d2e7'
    ],
    dataLabels: {
      enabled: false,
      textAnchor: 'start',
      style: {
        colors: ['#fff']
      },
      formatter: function (val, opt) {
        return opt.w.globals.labels[opt.dataPointIndex] + ":  " + val
      },
      offsetX: 0,
      dropShadow: {
        enabled: true
      }
    },
    stroke: {
      width: 1,
      colors: ['#fff']
    },
    xaxis: {
      categories: [],
    },
    yaxis: {
      labels: {
        show: true
      }
    },
    title: {},
    subtitle: {},
    tooltip: {
      theme: 'dark',
      x: {
        show: false
      },
      y: {
        title: {
          formatter: function () {
            return ''
          }
        }
      }
    }
  };
  
  {% comment %} var options_events_methods_of_execution = {
  series: [{
  name: '',
  data: []
  }],
  chart: {
  height: 350,
  type: 'bar',
  },
  plotOptions: {
  bar: {
  borderRadius: 10,
  dataLabels: {
  position: 'top', // top, center, bottom
  },
  }
  },
  dataLabels: {
  enabled: true,
  formatter: function (val) {
  return val;
  },
  offsetY: -20,
  style: {
  fontSize: '12px',
  colors: ["#304758"]
  }
  },
  
  xaxis: {
  categories: [],
  position: 'top',
  axisBorder: {
  show: false
  },
  axisTicks: {
  show: false
  },
  crosshairs: {
  fill: {
  type: 'gradient',
  gradient: {
  colorFrom: '#D8E3F0',
  colorTo: '#BED1E6',
  stops: [0, 100],
  opacityFrom: 0.4,
  opacityTo: 0.5,
  }
  }
  },
  tooltip: {
  enabled: true,
  }
  },
  yaxis: {
  axisBorder: {
  show: false
  },
  axisTicks: {
  show: false,
  },
  labels: {
  show: true,
  }
  
  },
  title: {}
  }; {% endcomment %}
  
  {% comment %}   
  
  var options_events_methods_of_execution = {
  series: [],
  chart: {
  width: "100%",
  type: 'pie',
  },
  dataLabels: {
  enabled: true
  },
  fill: {
  type: 'gradient',
  },
  legend: {
  formatter: function(val, opts) {
  return val + " - " + opts.w.globals.series[opts.seriesIndex]
  }
  },
  labels: [],
  responsive: [{
  breakpoint: 700,
  options: {
  chart: {
  width: "100%"
  },
  legend: {
  position: 'bottom'
  }
  }
  }]
  };
  {% endcomment %}
  
  
  const app_events_methods_of_execution = Vue.createApp({
    delimiters: ['[[', ']]'],
    data () {
      return {
        error: false
      }
    },
    mounted () {
      this.getCounters()
    },
    methods: {
      myFunction(item) {
        options_events_methods_of_execution.xaxis.categories.push(item.method_of_execution__description)
        options_events_methods_of_execution.series[0].data.push(item.num_iniziative)
      },
      getCounters() {
        axios
        .get("{{ api_url }}", {
          params: {
            year: "{{ year }}"
          }
        })
        .then(response => {
          this.error_msg = ""
          this.error_status = null
          response.data.forEach(this.myFunction)
          var chart = new ApexCharts(document.querySelector("#chart_events_methods_of_execution"), options_events_methods_of_execution)
          chart.render()
        })
        .catch(error => {
          if(error) {
            this.error = true
            this.error_msg = error.response.data.detail
            this.error_status = error.response.status
          }
        })
      },
    }
  }).mount('#app_events_methods_of_execution')
</script>
